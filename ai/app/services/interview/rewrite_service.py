"""
SK AXIS AI ë©´ì ‘ ë‹µë³€ ë¦¬ë¼ì´íŒ… ì„œë¹„ìŠ¤

ì´ íŒŒì¼ì€ STT(ìŒì„±ì¸ì‹) ê²°ê³¼ë¥¼ ì˜ë¯¸ë¥¼ ë³´ì¡´í•˜ë©´ì„œ ì •ì œí•˜ëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.
ì£¼ìš” ê¸°ëŠ¥:
- STT ì˜¤ë¥˜ ë° ë¬¸ë²• ì˜¤ë¥˜ ìˆ˜ì •
- ë¶ˆí•„ìš”í•œ ê³µë°± ë° ë°˜ë³µ ì œê±°
- ë©´ì ‘ê´€ ë°œì–¸ í•„í„°ë§ (ì§€ì›ì ë‹µë³€ë§Œ ë³´ì¡´)
- ì§ˆë¬¸-ë‹µë³€ íë¦„ ìœ ì§€

ì²˜ë¦¬ ì›ì¹™:
- ì§€ì›ì ë‹µë³€ì˜ í•µì‹¬ ì˜ë¯¸ëŠ” ì ˆëŒ€ ë³€ê²½í•˜ì§€ ì•ŠìŒ
- ë¬¸ë²•ì  ì •í™•ì„± í–¥ìƒ
- ë©´ì ‘ í‰ê°€ì— ì í•©í•œ í˜•íƒœë¡œ ì •ì œ
- GPT-4o-mini ì‚¬ìš©ìœ¼ë¡œ ë¹„ìš© ì ˆì•½

ì‚¬ìš© ì‹œì :
STT ì™„ë£Œ â†’ rewrite_service â†’ evaluation_service ìˆœì„œë¡œ íŒŒì´í”„ë¼ì¸ ì§„í–‰
"""

import time
import os
from dotenv import load_dotenv
import openai

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğŸ” í™˜ê²½ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Load environment variables and initialize API key
load_dotenv()
openai.api_key = os.getenv("OPENAI_API_KEY")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğŸ§  ë¦¬ë¼ì´íŒ… í”„ë¡¬í”„íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í”„ë¡¬í”„íŠ¸: ì˜ë¯¸ ë³´ì¡´ + ë¬¸ë²•/ê³µë°± ì •ì œ + ì§ˆë¬¸-ë‹µë³€ íë¦„ ìœ ì§€
REWRITE_PROMPT = """
ë‹¤ìŒì€ ë©´ì ‘ ëŒ€í™” STT ê²°ê³¼ì…ë‹ˆë‹¤. ì§€ì›ì ë‹µë³€ì˜ ì˜ë¯¸ëŠ” ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”.

ì²˜ë¦¬ ê·œì¹™:
- ë¬¸ë²• ì˜¤ë¥˜ ë° ì˜¤íƒˆì ìˆ˜ì •
- ë¶ˆí•„ìš”í•œ ê³µë°± ì œê±°
- í•µì‹¬ ë‚´ìš©(ì§ˆë¬¸-ë‹µë³€ íë¦„)ì€ ê·¸ëŒ€ë¡œ ë³´ì¡´
- ë©´ì ‘ê´€ ë‹µë³€ì´ í¬ì°©ë˜ë©´ í•´ë‹¹ ë¶€ë¶„ì€ ì œê±°
- ì§€ì›ìì˜ ì˜ë„ì™€ ì˜ë¯¸ë¥¼ ìµœëŒ€í•œ ë³´ì¡´

ì›ë³¸ STT ê²°ê³¼:
{answer_raw}
"""

async def rewrite_answer(raw: str) -> tuple[str, float]:
    """
    STTë¡œ ë°›ì€ raw í…ìŠ¤íŠ¸ë¥¼ ì˜ë¯¸ ë³´ì¡´ ê¸°ë°˜ìœ¼ë¡œ ì •ì œí•©ë‹ˆë‹¤.
    
    Args:
        raw (str): STT ì›ë³¸ í…ìŠ¤íŠ¸ (ë¬¸ë²• ì˜¤ë¥˜, ê³µë°± ë¬¸ì œ ë“± í¬í•¨)
        
    Returns:
        tuple[str, float]: (ì •ì œëœ ë‹µë³€, ì²˜ë¦¬ ì‹œê°„ ì´ˆ)
        - ì •ì œëœ ë‹µë³€: ë¬¸ë²• ìˆ˜ì • ë° ì •ë¦¬ëœ í…ìŠ¤íŠ¸
        - ì²˜ë¦¬ ì‹œê°„: GPT API í˜¸ì¶œ ì†Œìš” ì‹œê°„ (ì´ˆ ë‹¨ìœ„)
        
    Note:
        - GPT-4o-mini ëª¨ë¸ ì‚¬ìš© (ë¹„ìš© ì ˆì•½)
        - temperature=0.0ìœ¼ë¡œ ì¼ê´€ì„± ìˆëŠ” ê²°ê³¼ ë³´ì¥
        - ìµœëŒ€ 1024 í† í°ìœ¼ë¡œ ì œí•œí•˜ì—¬ ë¹„ìš© ê´€ë¦¬
    """
    # GPT í”„ë¡¬í”„íŠ¸ì— ì›ë³¸ í…ìŠ¤íŠ¸ ì‚½ì…
    prompt = REWRITE_PROMPT.format(answer_raw=raw)
    
    # ì²˜ë¦¬ ì‹œê°„ ì¸¡ì • ì‹œì‘
    start = time.perf_counter()
    
    # OpenAI GPT API í˜¸ì¶œ
    response = openai.chat.completions.create(
        model="gpt-4o-mini",    # ë¹„ìš© ì ˆì•½ì„ ìœ„í•´ mini ëª¨ë¸ ì‚¬ìš©
        messages=[{"role": "user", "content": prompt}],
        max_tokens=1024,        # ì¶œë ¥ ê¸¸ì´ ì œí•œ (ë¹„ìš© ê´€ë¦¬)
        temperature=0.0         # ì¼ê´€ì„± ìˆëŠ” ì •ì œ ê²°ê³¼ë¥¼ ìœ„í•´ 0ìœ¼ë¡œ ì„¤ì •
    )
    
    # ì²˜ë¦¬ ì‹œê°„ ê³„ì‚°
    elapsed = time.perf_counter() - start
    
    # GPT ì‘ë‹µì—ì„œ ì •ì œëœ í…ìŠ¤íŠ¸ ì¶”ì¶œ
    rewritten = response.choices[0].message.content.strip()
    
    return rewritten, round(elapsed, 2)
